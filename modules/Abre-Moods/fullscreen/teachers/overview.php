<?php
//echo "overivew";
require_once(dirname(__FILE__) . '/../../../../core/abre_verification.php');
echo "<link rel='stylesheet' type='text/css' href='/modules/" . basename(dirname(__DIR__, 2)) . "/css/teacher/moods-overview.css'>";
?>

<div id="entire_class" class="zone mdl-shadow--4dp moods-section">
    <div id="class_head_bar" class="zone_head_bar">
        <div id="class_picker" class="">
            <span class="class_name">Test Class</span><span class="bell">Bell #</span>
            <i class="material-icons pick_bell">expand_more</i>
        </div>

        <span class="num_students">##/##</span>
        <div class="loading_bar class_progress_bar"></div>
    </div>
    <div class="students_container">
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
        <div class="student">
            <div class="student_image">
                <i class="student_mood"></i>
            </div>
            Name
        </div>
    </div>
</div>
<div id="zone_information" class="moods-section centered_container no_padding">
    <div id="blue" class="zone mdl-shadow--4dp">
        <div class="zone_head_bar">
            Blue Zone
            <span class="num_students">##/##</span>
            <div class="loading_bar"></div>
        </div>
        <div class="students_container">
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
        </div>
    </div>
    <div id="green" class="zone mdl-shadow--4dp">
        <div class="zone_head_bar">
            Green Zone
            <span class="num_students">##/##</span>
            <div class="loading_bar"></div>
        </div>
        <div class="students_container">
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
        </div>
    </div>
    <div id="yellow" class="zone mdl-shadow--4dp">
        <div class="zone_head_bar">
            Yellow Zone
            <span class="num_students">##/##</span>
            <div class="loading_bar"></div>
        </div>
        <div class="students_container">
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
        </div>
    </div>
    <div id="red" class="zone mdl-shadow--4dp">
        <div class="zone_head_bar">
            Red Zone
            <span class="num_students">##/##</span>
            <div class="loading_bar"></div>
        </div>
        <div class="students_container">
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
            <div class="student">
                <div class="student_image">
                    <i class="student_mood"></i>
                </div>
                Name
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var selectedClass = 0;

    var closeDropdown = function() {
        $('.select_dropdown').remove();
        $('.click_catcher').remove();
        $('.pick_bell').removeClass('dd_active').addClass('dd_inactive');
    };

    var createClassDropdown = function (options) {
        var layout = [`<div class='class_select_dropdown' data-index="`, `">
                        <span class="class_name">`, `</span><span class="bell">Bell `, `</span>
                      </div>`];

        $('#class_head_bar').after(`<div class="select_dropdown mdl-shadow--4dp"></div>`);
        $('.mdl-layout__content').append(`<div class='click_catcher'></div>`);
        $('.click_catcher').click(function () {
            closeDropdown()
        });
        options.forEach(function (element, index) {
            $('.select_dropdown').append(layout[0] + (index + 1) + layout[1] + element + layout[2] + (index + 1) + layout[3]);
        });

        $('.class_select_dropdown').click(function () {
            selectedClass = $(this).data('index') - 1;
            closeDropdown();
            pageDataManager.displayData();
        });
    };

    class dataManager {
        studentData = {};
        classes = [];

        constructor() {
            this.updateClasses();
            this.updateData();
        }

        updateClasses() {
            var tempClasses;
            var jqxhr = $.post('/modules/Abre-Moods/data_access/teachers/get_classes.php');

            //Used arrow function here, allows for 'this' to reference the dataManager class instead of the funciton call
            jqxhr.done(data => {
                tempClasses = JSON.parse(data);
                this.classes = tempClasses
            });
        }

        updateData() {
            var jqxhr = $.post('/modules/Abre-Moods/data_access/teachers/get_all_students_status.php', {
                "amount": "full",
                "bell": selectedClass
            });
            //Same here with the arrow function, it makes everything easier
            jqxhr.done(data => {
                if (data === JSON.stringify(this.studentData)) {

                } else {
                    this.studentData = JSON.parse(data);
                    this.displayData();
                }
            });
        }

        displayData() {
            this.updateDisplayBars()
            this.updateDisplayNums()
        }

        updateDisplayBars() {
            var data = this.studentData;
            //animate total bar
            $('.class_progress_bar').animate({'width': 100 * (data.totalStudents - data.totalResponses)/data.totalStudents + '%'});
            //animate blue bar
            $('#blue .zone_head_bar .loading_bar').animate({'width': 100 * (data.totalStudents - data.blue)/data.totalStudents + '%'});
            //animate green bar
            $('#green .zone_head_bar .loading_bar').animate({'width': 100 * (data.totalStudents - data.green)/data.totalStudents + '%'});
            //
            $('#yellow .zone_head_bar .loading_bar').animate({'width': 100 * (data.totalStudents - data.yellow)/data.totalStudents + '%'});
            //
            $('#red .zone_head_bar .loading_bar').animate({'width': 100 * (data.totalStudents - data.red)/data.totalStudents + '%'});
        }

        updateDisplayNums() {
            var data = this.studentData;
            //update class
            $('#class_head_bar span.num_students').text(data.totalResponses + "/" + data.totalStudents);
            //update blue
            $('#blue .zone_head_bar .num_students').text(data.blue + "/" + data.totalStudents);
            //update green
            $('#green .zone_head_bar .num_students').text(data.green + "/" + data.totalStudents);
            //update yellow
            $('#yellow .zone_head_bar .num_students').text(data.yellow + "/" + data.totalStudents);
            //update red
            $('#red .zone_head_bar .num_students').text(data.red + "/" + data.totalStudents);
        }

        updatePeopleLocations() {

        }
    }

    var pageDataManager = new dataManager();
    //Have to use .bind to set it to the correct object
    setNamedInterval("data", pageDataManager.updateData.bind(pageDataManager), 100);

    $(document).ready(function () {
        $('.pick_bell').click(function(){
            var arrow = $(this);
            if (arrow.hasClass('dd_active')) {
                closeDropdown();
            } else {
                pageDataManager.updateClasses();
                arrow.removeClass('dd_inactive');
                arrow.addClass('dd_active');
                createClassDropdown(pageDataManager.classes);
            }
        });
    });
</script>
